#!/bin/bash

if [ -f /etc/pacmanrepo.conf ]
then
	. /etc/pacmanrepo.conf
fi

if [ -z "$REPO_NAME" ]
then
	REPO_NAME=$1
fi

if [ -z "$REPO_NAME" ]
then
	echo Repo name is needed as first parameter
	exit 1
fi

cd /var/lib/pacman-repo-builder
su pacmanrepobuilder -c 'mkdir -p pkgs'

RC=0


if [ -f keys.list ]
then
	for C in $(cat keys.list)
	do
		su pacmanrepobuilder -c "gpg --keyserver {{ server_pacmanrepo_keyserver }}  --recv-keys $C"
	done
fi

if [ -f deps.list ]
then
	for C in $(cat deps.list)
	do
		cd pkgs
		if [ ! -d "$C" ]
		then
			su pacmanrepobuilder -c 'git clone "https://aur.archlinux.org/'${C}'.git"' || (( RC++ ))
		fi
		cd "$C"
		su pacmanrepobuilder -c 'git pull'
		
		NEW_MD5=$(find . -type f -not -path '*/\.git/*' -exec md5sum {} + | LC_ALL=C sort | md5sum)
		
		[ "$(cat ../$C.md5)" = "$NEW_MD5" ] && cd ../.. && continue;
		
		su pacmanrepobuilder -c 'makepkg -sf --sign --noconfirm'
		CRC=$?
		
		if [ ! \( "$ALLOW_SIGN_FAIL" = true -a $CRC -eq 16 \) ] && [ $CRC -ne 0 ]
		then
			(( RC++ ))
		else
			su pacmanrepobuilder -c "find . -type f -not -path '*/\.git/*' -exec md5sum {} + | LC_ALL=C sort | md5sum > ../$C.md5"
		fi
		
		pacman -U --asdeps --noconfirm $(ls *.pkg.tar.zst | sort | tail -n 1)
		cd ../..
	done
fi

if [ -f packages.list ]
then
	for C in $(cat packages.list)
	do
		cd pkgs/
		if [ ! -d "$C" ]
		then
			su pacmanrepobuilder -c 'git clone "https://aur.archlinux.org/'${C}'.git"'
		fi
		cd "$C"
		su pacmanrepobuilder -c 'git pull'
		
		NEW_MD5=$(find . -type f -not -path '*/\.git/*' -exec md5sum {} + | LC_ALL=C sort | md5sum)
		
		[ "$(cat ../$C.md5)" = "$NEW_MD5" ] && cd ../.. && continue;
		
		su pacmanrepobuilder -c 'makepkg -sf --sign --noconfirm'
		
		CRC=$?
		if [ ! \( "$ALLOW_SIGN_FAIL" = true -a $CRC -eq 16 \) ] && [ $CRC -ne 0 ]
		then
			(( RC++ ))
		else
			su pacmanrepobuilder -c "find . -type f -not -path '*/\.git/*' -exec md5sum {} + | LC_ALL=C sort | md5sum > ../$C.md5"
		fi
		cd ../..
	done
fi

su pacmanrepobuilder -c 'mkdir -p repo/'

su pacmanrepobuilder -c 'find pkgs -name "*.tar.zst*" -exec cp {} repo/ \;'  || (( RC++ ))

cd repo

rm -f $REPO_NAME.db
rm -f $REPO_NAME.db.tar.zst
rm -f $REPO_NAME.files
rm -f $REPO_NAME.files.tar.zst

if [ 0 -ne $( ls | wc -l ) ]
then
	su pacmanrepobuilder -c 'repo-add '"$REPO_NAME"'.db.tar.zst *' || (( RC++ ))
fi

echo Aggregated return code is $RC
exit $RC
