- user:
    name: pacmanrepo
    create_home: yes
    home: /var/lib/pacman-repo
  tags:
    - config
    
- name: Configure pacmanrepo dir
  file:
    path: "{{ item }}"
    owner: pacmanrepo
    group: pacmanrepo
    mode: '{{ server_pacmanrepo_access_rights | default("0555") }}'
    state: directory
  loop:
    - '/var/lib/pacman-repo'
    - '/var/lib/pacman-repo/packages'
  tags:
    - config

- name: 'Create certificates'
  command: certbot certonly --standalone --http-01-port {{ letsencrypt_port }} -d {{ item }}.{{ domain }} -m {{ letsencrypt_mail }} --agree-tos -n
  args:
    creates: /etc/letsencrypt/live/{{ item }}.{{ domain }}/privkey.pem
  loop:
    - repo
  notify: restart_nginx
  tags:
    - config

- name: 'Create config nginx'
  template:
    src: nginx/repo.conf.j2
    dest: '/etc/nginx/servers.d/pacman-repo.conf'
    mode: '0700'
  notify: restart_nginx
  tags:
    - config
    
- name: 'Create empty repo'
  command: 'repo-add /var/lib/pacman-repo/packages/{{ server_pacmanrepo_name }}.db.tar.zst'
  args:
    creates: /var/lib/pacman-repo/packages/{{ server_pacmanrepo_name }}.db.tar.zst
  when: server_pacmanrepo_name is defined
